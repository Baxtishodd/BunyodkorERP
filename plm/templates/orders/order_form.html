{% extends "base1.html" %}
{% block content %}
<div class="page-header">
  <div class="page-block">
    <div class="page-header-title">
      <h3>{% if order %}Buyurtmani tahrirlash{% else %}Yangi buyurtma{% endif %}</h3>
    </div>
    <ul class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Buyurtma</a></li>
      <li class="breadcrumb-item" aria-current="page">
        {% if order %}Buyurtmani tahrirlash{% else %}Yangi buyurtma{% endif %}
      </li>
    </ul>
  </div>
</div>

<div class="container my-5 d-flex justify-content-center">
  <div class="col-lg-8 col-md-10">
    <div class="p-4 p-md-5 bg-white rounded-4 shadow-sm border-0">
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="row g-4">

          {% for field in form %}
            {% if field.name != "model_picture" %}
              <div class="col-md-6">
                <label class="form-label fw-semibold">{{ field.label }}</label>
                {{ field }}
              </div>
            {% endif %}
          {% endfor %}

          <!-- 📸 Drag & Drop Rasm YUKLASH -->
          <div class="col-md-12 text-center mt-4">
            <div id="dropZone"
                 class="border border-2 border-dashed rounded-4 p-5 text-center bg-light"
                 style="cursor: pointer;">
              <i class="bi bi-cloud-upload text-success display-5 d-block mb-2"></i>
              <p class="mb-1 fw-semibold text-secondary">Rasmni bu yerga tashlang yoki tanlang</p>
              <small class="text-muted">PNG, JPG yoki JPEG formatdagi fayllar</small>
              {{ form.model_picture }}
            </div>

            <div class="mt-4">
              <img id="imagePreview"
                   src="{% if form.instance.model_picture %}{{ form.instance.model_picture.url }}{% endif %}"
                   alt="Model rasmi"
                   class="img-fluid rounded-3 shadow-sm"
                   style="max-width: 300px; display: {% if form.instance.model_picture %}block{% else %}none{% endif %};">
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-center mt-5">
          <button type="submit" class="btn btn-success px-4 me-2 rounded-pill">
            <i class="bi bi-check-circle me-1"></i> Saqlash
          </button>
          <a href="{% url 'plm:order_list' %}" class="btn btn-outline-secondary px-4 rounded-pill">
            <i class="bi bi-x-circle me-1"></i> Bekor qilish
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- 🔁 Drag & Drop + Preview JS -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.querySelector('input[type="file"][name$="model_picture"]');
  const preview = document.getElementById("imagePreview");

  // Inputni yashirish
  if (fileInput) fileInput.style.display = "none";

  // DropZone click orqali fayl tanlash
  dropZone.addEventListener("click", () => fileInput.click());

  // Fayl tanlanganda preview ko‘rsatish
  fileInput.addEventListener("change", handleFileSelect);

  // Drag va Drop eventlari
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("border-success", "bg-white");
  });

  dropZone.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-success", "bg-white");
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-success", "bg-white");
    const file = e.dataTransfer.files[0];
    if (file) {
      fileInput.files = e.dataTransfer.files;
      previewImage(file);
    }
  });

  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) previewImage(file);
  }

  function previewImage(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      preview.src = e.target.result;
      preview.style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});
</script>
{% endblock %}
